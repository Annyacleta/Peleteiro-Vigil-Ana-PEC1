
---
title: "Análisis de Datos Ómicos - PEC 1"
author: "Ana Peleteiro Vigil"
lang: es
format:
  pdf:
    include-in-header: header.tex
    pdf-engine: xelatex
    keep-tex: true
    toc: true
    number-sections: true
    toc-depth: 2
knit:
  quarto:
    chunk_options:
      echo: false
      cache: false
      prompt: false
      tidy: true
      comment: NA
      message: false
      warning: false
    knit_options:
      width: 75
---

```{r message=FALSE, warning=FALSE}
#| eval: false
#| include: false
if (!requireNamespace("BiocManager", quietly = TRUE)) {
  install.packages("BiocManager")
}

# Instalar xcms
if (!require(xcms)) {
  BiocManager::install("xcms")
}

# Instalar CAMERA
if (!require(CAMERA)) {
  BiocManager::install("CAMERA")
}

# Instalar MSnbase
if (!require(MSnbase)) {
  BiocManager::install("MSnbase")
}

# Instalar SummarizedExperiment
if (!require(SummarizedExperiment)) {
  BiocManager::install("SummarizedExperiment")
}
```

# Abstract

150 palabras

Los datos seleccionados para esta PEC provienen del análisis por LC-MS de muestras fecales de ratones con cáncer colorectal que recibieron un trasplante de microbiota de ratones sometidos a una dieta cetogénica o a una dieta estándar. tras un análisis exploratorio con XXXXXXX, comparé el metaboloma fecal de los dos grupos de ratones trasplantados para detectar diferencias en su composición, como señalan los autores del estudio. Encontré que....

HABLAR DEL PROCESO Y PRINCIPALES RESULTADOS... algo de free fatty acids??
OJO mi dataset quizás fue solo para caracterizar metabolómicamente los ratones GF trasplantados



# Objetivos


Media página

Objetivo global: Comparar los metabolitos en heces de los ratones trasplantados con "microbiota estándar" (MSD) y aquellos con "microbiota cetogénica" (MCG) para detectar diferencias en su composición.

objetivos específicos:

1. Crear un objeto de clase `SummarizedExperiment` que contenga los datos y los metadatos (información acerca del dataset, sus filas y columnas).

2. Estudiar la calidad de los datos (preprocesado) -> raw data, deberían estar ok igualmente? normalizar, escalar para PCA.

2. Análisis de datos exploratorio -> dimensiones, números de grupos, número de muestras, nombre de los grupos, número de metabolitos, número de medidas (foramto tabla). Histogramas? barplot con la cantidad de cada metabolito en los ratones, diferenciando por colores según grupo. Visualización/agrupación multivariante: Mostrar PC1 y PC2 para agrupar muestras, dendrograma para ver si se da un agrupamiento jerárquico de las muestras.


3. Búsqueda de un perfil de metabolitos fecales diferencial entre ratones MSD y ratones MCG -> el objetivo final del estudio es ver si esto condiciona el desarrollo tumoral en el intensitno grueso distal. FOCO EN FREE FATTY ACIDS! -> Prueba t, volcano plot



# Métodos

1-2 páginas

## Archivos derivados de esta PEC

En el repositorio GitHub, indicado en las referencias...

## Origen y naturaleza de los datos

El dataset empleado para este ejercicio ha sido extraído del repositorio del Metabolomics Workbench (https://www.metabolomicsworkbench.org/).

- ID del proyecto: PR002283 ("Ketogenic diet suppresses colorectal cancer through the gut microbiome long chain fatty acid stearate")

- Fecha de publicación: 20-01-2025

- ID del estudio: ST003680 ("Untargeted LCMS data from Cecal Microbiota Transplant (CMT) experiment")

Siguiendo las recomendaciones del repositorio Metabolomics Workbench, opté por descargar el archivo comprimido (12 GB) con el dataset en formato .mzML a través de un servidor FTP anónimo con FileZilla, un cliente FTP gratuito y ampliamente utilizado.

El dataset procede de un experimento con ratones libres de gérmenes, que recibieron contenido cecal (del ciego, en el intestino grueso) de ratones alimentados con una dieta cetogénica (KC) o de ratones alimentados con una dieta estándar (SC). Después, estos ratones fueron sometidos al tratamiento con AOM/DSS, inductor de carcinogénesis y colitis, según lo descrito en Tsenkova et al. (2025). -> Fig 2.a paper

Las muestras fecales de los ratones se analizaron mediante una estrategia de LC-MS para caracterizar el metaboloma fecal de los diferentes grupos experimentales. Los metabolitos se extrajeron de las muestras fecales de ratón y las muestras resultantes se utilizaron para un análisis de metabolómica no dirigida por LC-MS, utilizando un sistema Vanquish UHPLC acoplado a un espectrómetro de masas Q Exactive HF.


PAPER
Cómo se hizo la cuantificación de metabolitos de muestras fecales murinas:

Preprocesasdo de los datos: 
Metabolomic profiling data pre-processing of untargeted LC-MS
datasets
Raw data files obtained through LC-MS of human stool and murine
plasma and stool samples were processed in TraceFinder (version
5.1.203.0) for peak identification and annotation. Three different inhouse
libraries, generated with reference standards, as well as one
commercially available library, mzCloud Offline for mzVault
2.3_Omics_2020A.db, in the Advanced Mass Spectral Database (AMSD)
(HighChem, from ThermoFischer Scientific), were used for peak
annotation, with the adduct formulas [M + H]+ and [M-H]-. Annotated
features and integration tables were exported for post-processing.



## Herramientas estadísticas y bioinformáticas


VER https://bioconductor.org/packages/release/bioc/vignettes/SummarizedExperiment/inst/doc/SummarizedExperiment.html

La clase `ExpressionSet`, del paquete `Biobase` fue diseñada para procesar datos de microarrays, mientras que `SummarizedExperiment` fue concebida desde el inicio para el manejo de datos ómicos modernos, como RNA-seq, ChIP-seq o metabolómica. Esta última permite almacenar múltiples matrices de datos (`assays`), en contraste con `ExpressionSet`, que contiene una única matriz principal (`exprs`). Por su mayor flexibilidad, eficiencia y compatibilidad con flujos de trabajo actuales en Bioconductor, `SummarizedExperiment` es la clase recomendada para manejar datos ómicos complejos.

A key aspect of the SummarizedExperiment class is the coordination of the meta-data and assays when subsetting. For example, if you want to exclude a given sample you can do for both the meta-data and assay in one operation, which ensures the meta-data and observed data will remain in sync. Improperly accounting for meta and observational data has resulted in a number of incorrect results and retractions so this is a very desirable property.

SummarizedExperiment is in many ways similar to the historical ExpressionSet, the main distinction being that SummarizedExperiment is more flexible in it’s row information, allowing both GRanges based as well as those described by arbitrary DataFrames. This makes it ideally suited to a variety of experiments, particularly sequencing based experiments such as RNA-Seq and ChIp-Seq.

Herramientas compatibles para `SummarizedExperiment`: DESeq2, edgeR, limma-voom (actual)


## Procedimiento del análisis

- **Preprocesado**. Puesto que tengo los datos crudos, hice un preprocesado para obtener  una tabla de intensidades que puedas usar en análisis estadístico o construir un `SummarizedExperiment` empleando la herramienta MSconvertGUI [REF]. Para ello, cargué todos los archivos .mzML descomprimidos en la herramienta y añadí el filtro "Peak Picking" con los parámetros Vendor MS Level = 1. De esta forma, los datos de MS son centroidizados, es decir, pasamos los datos del modo perfil al modo centrado, que toma el pico máximo (centroide) de cada analito y reduce notablemente el tamaño del archivo (en este caso, ¡pasa de 16 a 6 GB!). Además, seleccioné la opción de compresión zlib para reducir la carga de RAM en el procesado.  


- **Análisis de datos exploratorio**


- **Análisis multivariante**

Quiero ver cuáles de los metabolitos son FFA (ojo estearato)!!! Poner aquí listado: 2-hydroxyhexadecanoic acid, 2-Hydroxybutyric acid (no es), ... igual no compensa, no sale el estearato = octadecanoic acid en este dataset, se hacen medidas en heces de ratones SPF y tb se buscan las bacterias que lo producen en nuestro dataset, pero esos son otros experimentos!



# Resultados


código, análisis, resultados con tablas y figuras, y explicaciones

4-5 páginas

```{r}
library(SummarizedExperiment)
library(tidyverse)

# Leer archivo completo como texto
file <- "ST003680_AN006041_metadata_data.txt"
raw_lines <- readLines(file)

# Localizar secciones de datos
start_data <- grep("MS_METABOLITE_DATA_START", raw_lines) + 2
end_data   <- grep("MS_METABOLITE_DATA_END", raw_lines) - 1
start_meta_rt <- grep("METABOLITES_START", raw_lines) + 1
end_meta_rt   <- grep("METABOLITES_END", raw_lines) - 1

# Leer matriz de expresión (metabolitos × muestras)
expr_raw <- read.delim(file, skip = start_data - 1, nrows = 175, check.names = FALSE) # 175 metabolitos = filas
expr_raw_HEADER <- read.delim(file, skip = start_data - 2, nrows = 177, check.names = FALSE)

# Convertir a numérico (muestras × metabolitos)
expr_data <- apply(expr_raw[, -1], 2, as.numeric) %>% 
  as.data.frame()

# Asignar nombres correctos
rownames(expr_data) <- expr_raw[[1]] # Nombres de metabolitos sin término "Factor"
colnames(expr_data) <- colnames(expr_raw_HEADER)[-1]  # Nombres de muestras sin término "Samples"   


# 1) Metadatos de muestras
factor_line <- raw_lines[start_data - 1]
factors <- unlist(strsplit(factor_line, "\t"))[-1]
#condition <- str_extract(factors, "Condition:KC|Condition:SC")
#condition <- str_replace(condition, "Condition:", "")


col_data <- data.frame(
  row.names = colnames(expr_data)
)

# 2) Metadatos de metabolitos (tiempo de retención)
metabolite_meta <- read.delim(file,
                              skip = start_meta_rt - 1,
                              nrows = end_meta_rt - start_meta_rt + 1,
                              stringsAsFactors = FALSE)
colnames(metabolite_meta) <- c("metabolite_name", "retention_time")
rownames(metabolite_meta) <- metabolite_meta$metabolite_name
metabolite_meta <- metabolite_meta[rownames(expr_data), , drop = FALSE]
rowData <- metabolite_meta[rownames(expr_data), ] # debe coincidir con FILAS de expr_data (metabolitos)

# colData debe coincidir con COLUMNAS de expr_data (muestras)
colData <- col_data[colnames(expr_data), ]

# Creo la clase SummarizedExperiment
se <- SummarizedExperiment(
  assays = list(intensity = as.matrix(expr_data)),  # Matriz numérica con todo el dataset
  rowData = rowData,   # Nombres de metabolitos
  colData = colData    # Nombres de muestras
)

# Guardo objeto SummarizeExperiment en formato binario .Rda
save(se, file = "metabolomics_dataset.Rda")
```


```{r}
#Código replicado para incluir metadatos
# Leer archivo completo como texto
file <- "ST003680_AN006041_metadata_data.txt"
raw_lines <- readLines(file)

# Localizar secciones de datos
start_data <- grep("MS_METABOLITE_DATA_START", raw_lines) + 2
end_data   <- grep("MS_METABOLITE_DATA_END", raw_lines) - 1
start_meta_rt <- grep("METABOLITES_START", raw_lines) + 1
end_meta_rt   <- grep("METABOLITES_END", raw_lines) - 1

# Leer matriz de expresión (metabolitos × muestras)
expr_raw <- read.delim(file, skip = start_data - 1, nrows = 175, check.names = FALSE) # 175 metabolitos = filas
expr_raw_HEADER <- read.delim(file, skip = start_data - 2, nrows = 177, check.names = FALSE)

# Convertir a numérico (muestras × metabolitos)
expr_data <- apply(expr_raw[, -1], 2, as.numeric) %>% 
  as.data.frame()

# Asignar nombres correctos
rownames(expr_data) <- expr_raw[[1]] # Nombres de metabolitos sin término "Factor"
colnames(expr_data) <- colnames(expr_raw_HEADER)[-1]  # Nombres de muestras sin término "Samples"   


# 1) Metadatos de muestras
factor_line <- raw_lines[start_data - 1]
factors <- unlist(strsplit(factor_line, "\t"))[-1]
#condition <- str_extract(factors, "Condition:KC|Condition:SC")
#condition <- str_replace(condition, "Condition:", "")


col_data <- data.frame(
  row.names = colnames(expr_data)
)

# 2) Metadatos de metabolitos (tiempo de retención)
metabolite_meta <- read.delim(file,
                              skip = start_meta_rt - 1,
                              nrows = end_meta_rt - start_meta_rt + 1,
                              stringsAsFactors = FALSE)
colnames(metabolite_meta) <- c("metabolite_name", "retention_time")
rownames(metabolite_meta) <- metabolite_meta$metabolite_name
metabolite_meta <- metabolite_meta[rownames(expr_data), , drop = FALSE]

# rowData debe coincidir con FILAS de expr_data (metabolitos)
# MODIFICO A PARTIR DE AQUÍIII! rowData <- metabolite_meta[rownames(expr_data), ]

rowData <- DataFrame(
  Metabolito = rownames(expr_data),
  RetentionTime = metabolite_meta[rownames(metabolite_meta),], # Tiempo de retención
  row.names = rownames(expr_data) # Asegúrate de que coincidan con las filas de expr_data
)

# colData debe coincidir con COLUMNAS de expr_data (muestras)
colData <- col_data[colnames(expr_data), ]

# Creo la clase SummarizedExperiment
se_2 <- SummarizedExperiment(
  assays = list(intensity = as.matrix(expr_data)),  # Matriz numérica con todo el dataset
  rowData = rowData,   # Nombres de metabolitos
  colData = colData    # Nombres de muestras
)

# Agregar metadatos generales al componente metadata
#Meter cada parámetro leído del .txt

metadata(se_2) <- list(
  ExperimentDescription = "Estudio metabolómico en muestras fecales de ratones",
  Date = Sys.Date(),
  Investigator = "Dr. Juan Pérez",
  PublicationReference = "DOI:10.1234/metabolomics.2025"
)

# Guardo metadatos del objeto SummarizeExperiment en formato binario .Rda
#Todo
#save(se, file = "metabolomics_dataset_2.qmd")

#Solo metadatos
#?? save(metadata(se_2), file = "metabolomics_metadata.qmd")
```
```{r}
se_2
assay(se_2)       # Accede a la matriz principal
rowData(se_2)     # Accede a los metadatos de las características
colData(se_2)     # Accede a los metadatos de las muestras
```

```{r}
#Análisis exploratorio

```



# Discusión


Reflexiones sobre limitaciones del estudio y sobre el trabajo realizado, en el contexto del problema biológico.
(Breve info del paper, tener en cuenta las bacterias que hay presentes en cada tipo de microbiota. Relación con efecto antitumoral-> esta parte no la he analizado, así que es una limitación de mi trabajo! se trata de un análisis parcial). Quizás con alguna figura del paper se puedan hacer comparaciones, pero no parece -> OJO mi dataset quizás fue solo para caracterizar metabolómicamente los ratones GF trasplantados

1 página


# Conclusiones


Media página 


# Referencias


Repositorio de GitHub: https://github.com/Annyacleta/Peleteiro-Vigil-Ana-PEC1


Tsenkova, M., Brauer, M., Pozdeev, V.I. et al. Ketogenic diet suppresses colorectal cancer through the gut microbiome long chain fatty acid stearate. Nat Commun 16, 1792 (2025). https://doi.org/10.1038/s41467-025-56678-0


https://bioconductor.org/packages/release/bioc/vignettes/SummarizedExperiment/inst/doc/SummarizedExperiment.html#constructing-a-summarizedexperiment

Chambers, M., Maclean, B., Burke, R. et al. A cross-platform toolkit for mass spectrometry and proteomics. Nat Biotechnol 30, 918–920 (2012). https://doi.org/10.1038/nbt.2377  MSconvert!!!!
